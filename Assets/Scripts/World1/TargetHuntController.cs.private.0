using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

// Firebase
using Firebase.Auth;
using Firebase.Database;

// حل تعارض Random: استخدمي URandom.Range(...)
using URandom = UnityEngine.Random;

public class TargetHuntController : MonoBehaviour
{
    [Header("References")]
    public YOLOObject365 yolo;
    public TextMeshProUGUI promptText;
    public TextMeshProUGUI timerText;
    public Button pickButton;
    public RectTransform highlightPrefab;

    [Header("Game Settings")]
    public string[] fallbackTargets = new string[] { "شخص", "كوب", "زجاجة", "كتاب" };
    [Range(0f, 1f)] public float minScore = 0.55f;
    public float minBoxSize = 40f;

    [Header("Timer")]
    public float roundTime = 60f;
    public float warnThreshold = 20f;

    [Header("Popups")]
    public GameObject successPopup;
    public GameObject failPopup;
    public GameObject timeUpPopup;
    public float autoHideSuccessAfter = 2.0f;
    public float autoHideFailAfter = 2.0f;
    public float autoHideTimeUpAfter = 2.5f;

    [Header("Audio (SFX)")]
    public AudioSource audioSource; // مؤثرات (نجاح/فشل/تحذير)
    public AudioClip successClip, failClip, timeUpClip, warningClip;

    // ===================== صوت الإرشاد لكل كلمة =====================
    [Header("Voice Prompts (Per Word)")]
    public AudioSource voiceSource; // مصدر صوت للجملة الكاملة "ابحث عن <الكلمة>"

    [Serializable]
    public class WordPrompt
    {
        [Tooltip("اكتبي الكلمة بالعربية بالضبط كما تظهر في الهدف (مثلاً: خاتم)")]
        public string word;
        [Tooltip("ملف صوت كامل يقول: ابحث عن <الكلمة>")]
        public AudioClip fullPromptClip;
    }

    [Tooltip("اربطي هنا الكلمات مع ملفاتها الصوتية الجاهزة (ابحث عن <الكلمة>)")]
    public List<WordPrompt> wordPrompts = new List<WordPrompt>();

    private readonly Dictionary<string, AudioClip> promptMap = new Dictionary<string, AudioClip>();

    [Header("Effects")]
    public float flashDuration = 0.5f;
    public int flashCount = 3;
    public float shakeDuration = 0.5f;
    public float shakeStrength = 10f;

    // ===== State =====
    private string currentTargetAr;
    private RectTransform liveHighlight;
    private float timeLeft;
    private bool roundActive, warningPlayed;
    private Coroutine popupRoutine;
    private bool rewardedThisRound;

    // Attempts / Firebase
    private bool attemptInitialized = false;
    private int currentAttempt = 0;
    private int attemptErrorCount = 0;
    private string parentId;
    private string selectedChildKey;
    private string currentLetter;

    // ===== قوائم الأهداف لكل حرف (حسب طلبك) =====
    private static readonly Dictionary<string, List<string>> LetterTargets =
        new Dictionary<string, List<string>>()
    {
        // خ: خاتم, خبز, خيمة, خيار, خلاط
        { "خ", new List<string> { "خاتم", "خبز", "خيمة", "خيار", "خلاط" } },

        // ر: رف، ربطة عنق، ريموت
        { "ر", new List<string> { "رف", "ربطة عنق", "ريموت" } },

        // ذ: ذهب
        { "ذ", new List<string> { "ذهب" } }
    };

    private List<string> activeTargets = new List<string>();

    // ============================== Lifecycle ==============================

    void Start()
    {
        // هوية
        currentLetter = string.IsNullOrEmpty(GameSession.CurrentLetter) ? "" : GameSession.CurrentLetter;
        parentId = FirebaseAuth.DefaultInstance.CurrentUser != null
            ? FirebaseAuth.DefaultInstance.CurrentUser.UserId
            : "debug_parent";

        if (pickButton != null)
        {
            pickButton.onClick.RemoveAllListeners();
            pickButton.onClick.AddListener(OnPickPressed);
        }

        if (highlightPrefab != null && yolo != null && yolo.displayImage != null)
        {
            liveHighlight = Instantiate(highlightPrefab, yolo.displayImage.rectTransform.parent);
            liveHighlight.gameObject.SetActive(false);
        }

        PrepareTargetsForCurrentLetter();
        BuildPromptMap(); // ✅ جهّز خريطة (كلمة -> ملف صوت كامل)
        HideAllPopups();

        // أول Attempt + Round
        StartCoroutine(InitChildThenStartRound());
    }

    void OnDestroy()
    {
        if (pickButton != null)
            pickButton.onClick.RemoveListener(OnPickPressed);
    }

    // ============================== Init ==============================

    IEnumerator InitChildThenStartRound()
    {
        var cm = FindObjectOfType<CoinsManager>();
        if (cm != null && !string.IsNullOrEmpty(CoinsManager.instance.SelectedChildKey))
        {
            selectedChildKey = CoinsManager.instance.SelectedChildKey;
        }
        else
        {
            yield return StartCoroutine(FindSelectedOrDisplayedChildKey());
        }

        yield return StartCoroutine(StartNewAttempt());
        StartNewRound();
        UpdateTimerUI();
    }

    void PrepareTargetsForCurrentLetter()
    {
        if (!string.IsNullOrEmpty(currentLetter) &&
            LetterTargets.TryGetValue(currentLetter, out var list) &&
            list != null && list.Count > 0)
        {
            activeTargets = new List<string>(list);
        }
        else
        {
            activeTargets = new List<string>(fallbackTargets);
        }
    }

    // ============================== Update ==============================

    void Update()
    {
        if (!roundActive || !attemptInitialized) return;

        timeLeft -= Time.deltaTime;

        if (!warningPlayed && timeLeft <= warnThreshold && timeLeft > 0f)
        {
            warningPlayed = true;
            PlayClip(warningClip);
            if (timerText != null) StartCoroutine(FlashTimer());
            if (pickButton != null) StartCoroutine(ShakeButton(pickButton.transform));
        }

        if (timeLeft <= 0f)
        {
            timeLeft = 0f;
            roundActive = false;
            if (liveHighlight != null) liveHighlight.gameObject.SetActive(false);

            // ✅ أوقفي صوت الإرشاد عند انتهاء الوقت
            StopVoicePrompt();

            SaveTimeUpAndFinalizeAttempt();

            ShowOnly(timeUpPopup);
            PlayClip(timeUpClip);

            RestartPopupRoutine(AutoHideThen(() =>
            {
                StartCoroutine(StartNewAttempt());
                StartNewRound(); // سيعيد تشغيل صوت الهدف الجديد تلقائيًا
            }, autoHideTimeUpAfter));
        }

        UpdateTimerUI();
    }

    // ============================== Round Control ==============================

    void StartNewRound()
    {
        rewardedThisRound = false;

        currentTargetAr = (activeTargets != null && activeTargets.Count > 0)
            ? activeTargets[URandom.Range(0, activeTargets.Count)]
            : "شخص";

        if (promptText != null)
            promptText.text = YOLOObject365.ShapeArabic($"ابحث عن: {currentTargetAr}");

        if (liveHighlight != null) liveHighlight.gameObject.SetActive(false);

        timeLeft = roundTime;
        roundActive = true;
        warningPlayed = false;

        HideAllPopups();
        UpdateTimerUI();

        // ✅ شغّل الجملة الصوتية الكاملة للهدف الحالي
        PlayTargetPrompt(currentTargetAr);
    }

    void OnPickPressed()
    {
        if (!roundActive || !attemptInitialized || yolo == null) return;

        if (yolo.HasArabicClass(currentTargetAr, minScore, minBoxSize, out var det))
        {
            // نجاح
            roundActive = false;

            if (liveHighlight != null)
            {
                PositionHighlight(liveHighlight, det.rectPx);
                liveHighlight.gameObject.SetActive(true);
            }

            // ✅ أوقفي صوت الإرشاد قبل مؤثرات النجاح
            StopVoicePrompt();

            AwardCoinsOnce(5);
            SaveARSuccess();

            RestartPopupRoutine(ShowSuccessThenReturn());
        }
        else
        {
            // خطأ داخل نفس المحاولة
            if (liveHighlight != null) liveHighlight.gameObject.SetActive(false);

            attemptErrorCount++;
            SaveAttemptError();

            // ✅ أوقفي أي صوت إرشادي قديم
            StopVoicePrompt();

            ShowOnly(failPopup);
            PlayClip(failClip);

            RestartPopupRoutine(AutoHideThen(() =>
            {
                currentTargetAr = (activeTargets != null && activeTargets.Count > 0)
                    ? activeTargets[URandom.Range(0, activeTargets.Count)]
                    : "شخص";

                if (promptText != null)
                    promptText.text = YOLOObject365.ShapeArabic($"ابحث عن: {currentTargetAr}");

                // ✅ شغّل جملة الهدف الجديد
                PlayTargetPrompt(currentTargetAr);

            }, autoHideFailAfter));
        }
    }

    // ============================== Success Flow ==============================

    IEnumerator ShowSuccessThenReturn()
    {
        ShowOnly(successPopup);

        float duration = autoHideSuccessAfter;
        if (successClip != null) duration = successClip.length;

        PlayClip(successClip);
        yield return new WaitForSeconds(duration);

        HideAllPopups();

        GameSession.CompleteARAndReturn();
    }

    void AwardCoinsOnce(int amount)
    {
        if (rewardedThisRound) return;
        rewardedThisRound = true;

        var cm = FindObjectOfType<CoinsManager>();
        if (cm != null)
        {
            cm.AddCoinsToSelectedChild(amount);
        }
        else
        {
            StartCoroutine(AddCoinsDirectToFirebase(amount));
        }
    }

    // ============================== Attempts / Firebase ==============================

    IEnumerator StartNewAttempt()
    {
        attemptInitialized = false;
        attemptErrorCount = 0;

        if (string.IsNullOrEmpty(selectedChildKey))
            yield return StartCoroutine(FindSelectedOrDisplayedChildKey());

        string attemptsPath = GetAttemptsPath();
        var task = FirebaseDatabase.DefaultInstance.RootReference.Child(attemptsPath).GetValueAsync();
        yield return new WaitUntil(() => task.IsCompleted);

        int maxAttempt = 0;
        if (task.Exception == null && task.Result != null && task.Result.Exists)
        {
            foreach (var att in task.Result.Children)
            {
                if (int.TryParse(att.Key, out int num) && num > maxAttempt)
                    maxAttempt = num;
            }
        }

        currentAttempt = maxAttempt + 1;
        attemptInitialized = true;

        var initUpdates = new Dictionary<string, object>
        {
            [$"{GetAttemptPath()}/errors"] = 0,
            [$"{GetAttemptPath()}/successes"] = 0,
            [$"{GetAttemptPath()}/finished"] = false,
            [$"{GetAttemptPath()}/ts"] = ServerValue.Timestamp
        };
        FirebaseDatabase.DefaultInstance.RootReference.UpdateChildrenAsync(initUpdates);
    }

    void SaveAttemptError()
    {
        if (!attemptInitialized) return;

        var updates = new Dictionary<string, object>
        {
            [$"{GetAttemptPath()}/errors"] = attemptErrorCount,
            [$"{GetAttemptPath()}/successes"] = 0,
            [$"{GetAttemptPath()}/finished"] = false,
            [$"{GetAttemptPath()}/ts"] = ServerValue.Timestamp
        };
        FirebaseDatabase.DefaultInstance.RootReference.UpdateChildrenAsync(updates);
    }

    void SaveARSuccess()
    {
        if (!attemptInitialized) return;

        var updates = new Dictionary<string, object>
        {
            [$"{GetAttemptPath()}/errors"] = attemptErrorCount,
            [$"{GetAttemptPath()}/successes"] = 1,
            [$"{GetAttemptPath()}/finished"] = true,
            [$"{GetAttemptPath()}/ts"] = ServerValue.Timestamp
        };
        FirebaseDatabase.DefaultInstance.RootReference.UpdateChildrenAsync(updates);
    }

    void SaveTimeUpAndFinalizeAttempt()
    {
        if (!attemptInitialized) return;

        var updates = new Dictionary<string, object>
        {
            [$"{GetAttemptPath()}/errors"] = attemptErrorCount,
            [$"{GetAttemptPath()}/successes"] = 0,
            [$"{GetAttemptPath()}/finished"] = true,
            [$"{GetAttemptPath()}/reason"] = "timeup",
            [$"{GetAttemptPath()}/ts"] = ServerValue.Timestamp
        };
        FirebaseDatabase.DefaultInstance.RootReference.UpdateChildrenAsync(updates);
    }

    string GetAttemptsPath()
    {
        return $"parents/{parentId}/children/{selectedChildKey}/letters/{currentLetter}/activities/ar/attempts";
    }

    string GetAttemptPath() => $"{GetAttemptsPath()}/{currentAttempt}";

    IEnumerator FindSelectedOrDisplayedChildKey()
    {
        if (string.IsNullOrEmpty(parentId)) yield break;

        var db = FirebaseDatabase.DefaultInstance;
        var childrenRef = db.RootReference.Child("parents").Child(parentId).Child("children");
        var getChildren = childrenRef.GetValueAsync();
        yield return new WaitUntil(() => getChildren.IsCompleted);

        if (getChildren.Exception != null || getChildren.Result == null || !getChildren.Result.Exists)
            yield break;

        foreach (var ch in getChildren.Result.Children)
        {
            bool isSel = false;
            bool.TryParse(ch.Child("selected")?.Value?.ToString(), out isSel);
            if (isSel) { selectedChildKey = ch.Key; yield break; }
        }

        foreach (var ch in getChildren.Result.Children)
        {
            bool disp = false;
            bool.TryParse(ch.Child("displayed")?.Value?.ToString(), out disp);
            if (disp) { selectedChildKey = ch.Key; yield break; }
        }
    }

    // ============================== UI Helpers ==============================

    void ShowOnly(GameObject popup)
    {
        HideAllPopups();
        if (popup) popup.SetActive(true);
    }

    public void HideAllPopups()
    {
        if (successPopup) successPopup.SetActive(false);
        if (failPopup) failPopup.SetActive(false);
        if (timeUpPopup) timeUpPopup.SetActive(false);
    }

    IEnumerator AutoHideThen(System.Action afterHide, float delay)
    {
        yield return new WaitForSeconds(delay);
        HideAllPopups();
        afterHide?.Invoke();
    }

    void RestartPopupRoutine(IEnumerator routine)
    {
        if (popupRoutine != null) StopCoroutine(popupRoutine);
        popupRoutine = StartCoroutine(routine);
    }

    void UpdateTimerUI()
    {
        if (timerText == null) return;
        timerText.text = $"{Mathf.CeilToInt(timeLeft)}";
        if (!roundActive) timerText.color = new Color(1f, .5f, .2f);
        else if (timeLeft <= warnThreshold) timerText.color = new Color(1f, .3f, .3f);
        else timerText.color = new Color(.20f, .33f, .55f);
    }

    void PositionHighlight(RectTransform rt, Rect rectPx)
    {
        if (rt == null) return;
        rt.anchorMin = new Vector2(0, 1);
        rt.anchorMax = new Vector2(0, 1);
        rt.pivot = new Vector2(0, 1);
        rt.anchoredPosition = new Vector2(rectPx.x, -rectPx.y);
        rt.sizeDelta = new Vector2(rectPx.width, rectPx.height);
    }

    void PlayClip(AudioClip clip)
    {
        if (audioSource != null && clip != null)
            audioSource.PlayOneShot(clip);
    }

    // ==================== أصوات الإرشاد لكل كلمة ====================

    void BuildPromptMap()
    {
        promptMap.Clear();
        if (wordPrompts == null) return;

        foreach (var e in wordPrompts)
        {
            if (e == null || string.IsNullOrWhiteSpace(e.word) || e.fullPromptClip == null) continue;
            // طبّعي النص العربي لتفادي اختلافات (ألف/ياء/تاء مربوطة/تطويل/تشكيل)
            var key = YOLOObject365.NormalizeArabic(e.word);
            promptMap[key] = e.fullPromptClip; // آخر تكرار يغلب
        }
    }

    void PlayTargetPrompt(string arabicTarget)
    {
        if (voiceSource == null || string.IsNullOrWhiteSpace(arabicTarget)) return;

        // أوقفي تشغيل سابق
        try { voiceSource.Stop(); } catch { }

        var key = YOLOObject365.NormalizeArabic(arabicTarget);
        if (promptMap.TryGetValue(key, out var clip) && clip != null)
        {
            voiceSource.PlayOneShot(clip);
        }
        else
        {
            // لو ما فيه ملف — نسكت
            // Debug.Log($"[AR] لا يوجد ملف صوت لـ {arabicTarget}");
        }
    }

    void StopVoicePrompt()
    {
        if (voiceSource != null && voiceSource.isPlaying) voiceSource.Stop();
    }

    // ============================== Coins fallback ==============================

    IEnumerator AddCoinsDirectToFirebase(int amount)
    {
        var auth = FirebaseAuth.DefaultInstance;
        if (auth.CurrentUser == null) yield break;

        string pid = auth.CurrentUser.UserId;
        var db = FirebaseDatabase.DefaultInstance;

        string childKey = selectedChildKey;
        if (string.IsNullOrEmpty(childKey))
        {
            yield return StartCoroutine(FindSelectedOrDisplayedChildKey());
            childKey = selectedChildKey;
            if (string.IsNullOrEmpty(childKey)) yield break;
        }

        string coinsPath = $"parents/{pid}/children/{childKey}/coins";
        var coinsRef = db.RootReference.Child(coinsPath);

        var tx = coinsRef.RunTransaction(mutable =>
        {
            long current = 0;
            if (mutable.Value != null)
            {
                if (mutable.Value is long l) current = l;
                else if (mutable.Value is double d) current = (long)d;
                else long.TryParse(mutable.Value.ToString(), out current);
            }
            mutable.Value = current + amount;
            return TransactionResult.Success(mutable);
        });

        yield return new WaitUntil(() => tx.IsCompleted);
    }

    // ============================== Visual FX ==============================

    IEnumerator FlashTimer()
    {
        if (timerText == null) yield break;
        Color orig = timerText.color;
        for (int i = 0; i < flashCount; i++)
        {
            timerText.color = Color.red;
            yield return new WaitForSeconds(flashDuration / (flashCount * 2));
            timerText.color = orig;
            yield return new WaitForSeconds(flashDuration / (flashCount * 2));
        }
    }

    IEnumerator ShakeButton(Transform t)
    {
        if (t == null) yield break;
        Vector3 orig = t.localPosition; float e = 0f;
        while (e < shakeDuration)
        {
            t.localPosition = orig + new Vector3(
                URandom.Range(-1f, 1f) * shakeStrength,
                URandom.Range(-1f, 1f) * shakeStrength,
                0
            );
            e += Time.deltaTime; yield return null;
        }
        t.localPosition = orig;
    }
}
